===== src/features/gpx-tools/index.js =====
export { default as GpxToolsPage } from './ui/GpxToolsPage'



===== src/features/gpx-tools/ui/GpxComparator.jsx =====
import React from 'react'
import { Card, Alert, Typography, Select } from 'antd'
import { SwapOutlined } from '@ant-design/icons'
import styles from './GpxComparator.module.css'

const { Title, Text } = Typography
const { Option } = Select

export default function GpxComparator({ track, tracks, user }) {
	if (!track) {
		return null
	}

	return (
		<Card className={styles.container}>
			<div className={styles.header}>
				<Title level={4} className={styles.title}>
					<SwapOutlined /> –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤
				</Title>
				<Text type='secondary' className={styles.subtitle}>
					–°—Ä–∞–≤–Ω–∏—Ç–µ –¥–≤–∞ —Ç—Ä–µ–∫–∞ –∫–∞–∫ –≤ Garmin Connect
				</Text>
			</div>

			<Alert
				message='–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'
				description='–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö —Ç—Ä–µ–∫–æ–≤ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è –≤ –º–µ—Ç—Ä–∞—Ö –∏ —Å–µ–∫—É–Ω–¥–∞—Ö —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.'
				type='info'
				showIcon
				className={styles.alert}
			/>

			<div className={styles.comparisonSetup}>
				<div className={styles.trackSelection}>
					<div className={styles.trackCard}>
						<Text strong>–¢—Ä–µ–∫ 1 (–æ—Å–Ω–æ–≤–Ω–æ–π)</Text>
						<Text>{track.filename}</Text>
						<Text type='secondary'>
							{Math.floor(track.time / 60)}:
							{(track.time % 60).toString().padStart(2, '0')}
						</Text>
					</div>

					<div className={styles.vsLabel}>VS</div>

					<div className={styles.trackCard}>
						<Text strong>–¢—Ä–µ–∫ 2 (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)</Text>
						<Select
							placeholder='–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è'
							className={styles.select}
							size='middle'
						>
							{tracks
								.filter(t => t.id !== track.id)
								.map(t => (
									<Option key={t.id} value={t.id}>
										{t.filename} ({Math.floor(t.time / 60)}:
										{(t.time % 60).toString().padStart(2, '0')})
									</Option>
								))}
						</Select>
					</div>
				</div>
			</div>

			<div className={styles.statsPreview}>
				<Text type='secondary'>–ë—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è:</Text>
				<ul className={styles.featuresList}>
					<li>–î–≤–µ –¥–≤–∏–∂—É—â–∏–µ—Å—è —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</li>
					<li>–û—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ –≤ –º–µ—Ç—Ä–∞—Ö –∏ —Å–µ–∫—É–Ω–¥–∞—Ö</li>
					<li>–°–æ–≤–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏/–≤—ã—Å–æ—Ç—ã</li>
					<li>–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö</li>
				</ul>
			</div>
		</Card>
	)
}



===== src/features/gpx-tools/ui/GpxEditor.jsx =====
import React, { useState, useEffect, useRef } from 'react'
import {
	Card,
	Alert,
	Typography,
	Slider,
	Button,
	Space,
	Row,
	Col,
	Statistic,
	message,
	Spin,
} from 'antd'
import {
	ScissorOutlined,
	SaveOutlined,
	UndoOutlined,
	PlayCircleOutlined,
	PauseCircleOutlined,
	LineChartOutlined,
} from '@ant-design/icons'
import TrackVisualizer from './components/TrackVisualizer'
import styles from './GpxEditor.module.css'

const { Title, Text, Paragraph } = Typography

export default function GpxEditor({ track, onTrackUpdated, user }) {
	const [loading, setLoading] = useState(true)
	const [trackData, setTrackData] = useState(null)
	const [trackPoints, setTrackPoints] = useState([])
	const [trimStart, setTrimStart] = useState(0)
	const [trimEnd, setTrimEnd] = useState(0)
	const [originalStats, setOriginalStats] = useState(null)
	const [trimmedStats, setTrimmedStats] = useState(null)
	const [isPlaying, setIsPlaying] = useState(false)
	const trackRef = useRef(null)



	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–µ–∫–∞
	useEffect(() => {
		if (!track) {
			setLoading(false)
			return
		}

		setLoading(true)
		setTrimStart(0)
		setTrimEnd(0)
		setTrackData(null)
		setTrackPoints([])

		// –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞ —á–µ—Ä–µ–∑ TrackVisualizer
		setLoading(false)
	}, [track])

	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–∫–∞ –∏–∑ TrackVisualizer
	// –í GpxEditor.jsx –≤—Ä–µ–º–µ–Ω–Ω–æ —É–ø—Ä–æ—Å—Ç–∏–º:
const handleTrackLoaded = (track, stats, points) => {
	console.log('üéØ –¢—Ä–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω, —Ç–æ—á–µ–∫:', points.length)

	if (!trackData) {
		setTrackData(track)
		setOriginalStats(stats)
		setTrackPoints(points)

		if (points.length > 0) {
			setTrimStart(0)
			setTrimEnd(points.length - 1)

			// –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
			calculateTrimmedStats(points, 0, points.length - 1)
		}
	}
}

	// –†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
const calculateTrimmedStats = (points, start, end) => {
	if (!points || points.length === 0 || start >= end) {
		setTrimmedStats(null)
		return
	}

	const trimmedPoints = points.slice(start, end + 1)
	const stats = {
		points: trimmedPoints.length,
		percentage: ((trimmedPoints.length / points.length) * 100).toFixed(1),
		startIndex: start,
		endIndex: end,
	}

	setTrimmedStats(stats)
}

	// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ (–≤ –º–µ—Ç—Ä–∞—Ö)
	const calculateDistance = (lat1, lon1, lat2, lon2) => {
		const R = 6371000 // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –º–µ—Ç—Ä–∞—Ö
		const dLat = ((lat2 - lat1) * Math.PI) / 180
		const dLon = ((lon2 - lon1) * Math.PI) / 180
		const a =
			Math.sin(dLat / 2) * Math.sin(dLat / 2) +
			Math.cos((lat1 * Math.PI) / 180) *
				Math.cos((lat2 * Math.PI) / 180) *
				Math.sin(dLon / 2) *
				Math.sin(dLon / 2)
		const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
		return R * c
	}

	// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä–æ–≤
const handleStartChange = value => {
	if (value >= trimEnd) return
	setTrimStart(value)
	calculateTrimmedStats(trackPoints, value, trimEnd)
}

const handleEndChange = value => {
	if (value <= trimStart) return
	setTrimEnd(value)
	calculateTrimmedStats(trackPoints, trimStart, value)
}

	// –°–±—Ä–æ—Å –æ–±—Ä–µ–∑–∫–∏
	const handleReset = () => {
		if (!trackPoints.length) return
		setTrimStart(0)
		setTrimEnd(trackPoints.length - 1)
		calculateTrimmedStats(trackPoints, 0, trackPoints.length - 1)
	}

	// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
	const handleSaveTrimmed = async () => {
		if (!track || !trackPoints.length || !user) {
			message.warning('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è')
			return
		}

		try {
			setLoading(true)

			// TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ GPX —Ñ–∞–π–ª–∞ –≤ Supabase Storage
			// 1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π GPX —Ñ–∞–π–ª —Å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏
			// 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Storage
			// 3. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ lap_times

			message.success('–¢—Ä–µ–∫ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–µ–∑–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!')
			onTrackUpdated?.()
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error)
			message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç—Ä–µ–∫–∞: ' + error.message)
		} finally {
			setLoading(false)
		}
	}

	// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
	const handlePreviewTrimmed = () => {
		if (!trackPoints.length) return
		setIsPlaying(!isPlaying)
		// TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
	}

	if (!track) {
		return (
			<Alert
				message='–¢—Ä–µ–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω'
				description="–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ '–ú–æ–∏ —Ç—Ä–µ–∫–∏' –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
				type='info'
				showIcon
				className={styles.alert}
			/>
		)
	}

	return (
		<Card className={styles.container}>
			<div className={styles.header}>
				<Title level={4} className={styles.title}>
					<ScissorOutlined /> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞
				</Title>
				<Text type='secondary' className={styles.subtitle}>
					{track.filename}
				</Text>
			</div>

			{loading ? (
				<div className={styles.loadingContainer}>
					<Spin size='large' />
					<div className={styles.loadingText}>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞...</div>
				</div>
			) : (
				<Space direction='vertical' size='large' className={styles.content}>
					{/* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–∞ */}
					<div className={styles.visualizationSection}>
						<TrackVisualizer
							gpxUrl={track.url}
							onTrackLoaded={handleTrackLoaded}
							startMarker={trimStart}
							endMarker={trimEnd}
						/>
					</div>

					{/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–∫–∞ */}
					{originalStats && (
						<div className={styles.statsSection}>
							<Row gutter={[16, 16]}>
								<Col xs={24} sm={12} md={6}>
									<Statistic
										title='–ò—Å—Ö–æ–¥–Ω—ã—Ö —Ç–æ—á–µ–∫'
										value={originalStats.points}
										prefix={<LineChartOutlined />}
										className={styles.statistic}
									/>
								</Col>
								<Col xs={24} sm={12} md={6}>
									<Statistic
										title='–î–∏—Å—Ç–∞–Ω—Ü–∏—è'
										value={(originalStats.distance / 1000).toFixed(2)}
										suffix='–∫–º'
										className={styles.statistic}
									/>
								</Col>
								<Col xs={24} sm={12} md={6}>
									<Statistic
										title='–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å'
										value={
											originalStats.duration
												? `${Math.floor(originalStats.duration / 60)}:${(
														originalStats.duration % 60
												  )
														.toString()
														.padStart(2, '0')}`
												: '‚Äî'
										}
										prefix={<PlayCircleOutlined />}
										className={styles.statistic}
									/>
								</Col>
								<Col xs={24} sm={12} md={6}>
									<Statistic
										title='–ù–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã'
										value={
											originalStats.elevation
												? originalStats.elevation.toFixed(0)
												: '‚Äî'
										}
										suffix='–º'
										className={styles.statistic}
									/>
								</Col>
							</Row>
						</div>
					)}

					{/* –°–ª–∞–π–¥–µ—Ä—ã –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ */}
					{trackPoints.length > 0 && (
						<div className={styles.trimSection}>
							<Title level={5}>üî™ –û–±—Ä–µ–∑–∫–∞ —Ç—Ä–µ–∫–∞</Title>
							<Paragraph type='secondary'>
								–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é –∏ –∫–æ–Ω–µ—á–Ω—É—é —Ç–æ—á–∫–∏ –¥–ª—è –æ–±—Ä–µ–∑–∫–∏. –û–±—Ä–µ–∑–∞–Ω–Ω—ã–π
								—É—á–∞—Å—Ç–æ–∫ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –∑–∞—á–µ—Ç–Ω—ã–π –∫—Ä—É–≥.
							</Paragraph>

							<div className={styles.slidersContainer}>
								<div className={styles.sliderGroup}>
									<Text strong>–ù–∞—á–∞–ª–æ –æ–±—Ä–µ–∑–∫–∏:</Text>
									<Text type='secondary'>
										–¢–æ—á–∫–∞ {trimStart + 1} –∏–∑ {trackPoints.length}
									</Text>
									<Slider
										min={0}
										max={trackPoints.length - 1}
										value={trimStart}
										onChange={handleStartChange}
										tooltip={{ formatter: value => `–¢–æ—á–∫–∞ ${value + 1}` }}
										className={styles.slider}
										disabled={trackPoints.length === 0}
									/>
								</div>

								<div className={styles.sliderGroup}>
									<Text strong>–ö–æ–Ω–µ—Ü –æ–±—Ä–µ–∑–∫–∏:</Text>
									<Text type='secondary'>
										–¢–æ—á–∫–∞ {trimEnd + 1} –∏–∑ {trackPoints.length}
									</Text>
									<Slider
										min={0}
										max={trackPoints.length - 1}
										value={trimEnd}
										onChange={handleEndChange}
										tooltip={{ formatter: value => `–¢–æ—á–∫–∞ ${value + 1}` }}
										className={styles.slider}
										disabled={trackPoints.length === 0}
									/>
								</div>
							</div>

							{/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞ */}
							{trimmedStats && (
								<div className={styles.trimmedStats}>
									<Alert
										message={`–û–±—Ä–µ–∑–∞–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫: ${trimmedStats.points} —Ç–æ—á–µ–∫ (${trimmedStats.percentage}% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)`}
										description={`–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${(
											trimmedStats.distance / 1000
										).toFixed(2)} –∫–º`}
										type='success'
										showIcon
									/>
								</div>
							)}

							{/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
							<div className={styles.actions}>
								<Space wrap>
									<Button
										icon={<UndoOutlined />}
										onClick={handleReset}
										disabled={
											trimStart === 0 && trimEnd === trackPoints.length - 1
										}
									>
										–°–±—Ä–æ—Å–∏—Ç—å
									</Button>

									<Button
										icon={
											isPlaying ? (
												<PauseCircleOutlined />
											) : (
												<PlayCircleOutlined />
											)
										}
										onClick={handlePreviewTrimmed}
										type='default'
									>
										{isPlaying ? '–ü–∞—É–∑–∞' : '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä'}
									</Button>

									<Button
										type='primary'
										icon={<SaveOutlined />}
										onClick={handleSaveTrimmed}
										loading={loading}
									>
										–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–π —Ç—Ä–µ–∫
									</Button>
								</Space>
							</div>
						</div>
					)}

					{/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö */}
					<Alert
						message='–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞:'
						description={
							<ul className={styles.featuresList}>
								<li>–í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Ç—Ä–µ–∫–∞</li>
								<li>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞</li>
								<li>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∫ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞</li>
								<li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –ª–∏–¥–µ—Ä–æ–≤</li>
							</ul>
						}
						type='info'
						showIcon
					/>
				</Space>
			)}
		</Card>
	)
}



===== src/features/gpx-tools/ui/GpxList.jsx =====
import React, { useState } from 'react'
import {
	List,
	Card,
	Tag,
	Button,
	Space,
	Typography,
	Alert,
	Popconfirm,
	message,
	Tooltip,
	Empty,
} from 'antd'
import {
	PlayCircleOutlined,
	ScissorOutlined,
	SwapOutlined,
	SplitCellsOutlined,
	EyeOutlined,
	DeleteOutlined,
	DownloadOutlined,
	CheckCircleOutlined,
} from '@ant-design/icons'
import dayjs from 'dayjs'
import styles from './GpxList.module.css'

const { Text } = Typography

export default function GpxList({
	tracks,
	selectedTrack,
	onTrackSelect,
	onTrackDeleted,
	user,
}) {
	const [loadingDelete, setLoadingDelete] = useState(null)

	// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
	const formatTime = seconds => {
		const mins = Math.floor(seconds / 60)
		const secs = seconds % 60
		return `${mins}:${secs.toString().padStart(2, '0')}`
	}

	// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
	const formatDate = dateString => {
		return dayjs(dateString).format('DD.MM.YYYY HH:mm')
	}

	// –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞
	const handleDeleteTrack = async trackId => {
		setLoadingDelete(trackId)
		try {
			// TODO: –£–¥–∞–ª–∏—Ç—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã lap_times
			// TODO: –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –∏–∑ Storage
			message.success('–¢—Ä–µ–∫ —É–¥–∞–ª–µ–Ω')
			onTrackDeleted?.()
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error)
			message.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–µ–∫–∞')
		} finally {
			setLoadingDelete(null)
		}
	}

	// –î–µ–π—Å—Ç–≤–∏—è —Å —Ç—Ä–µ–∫–æ–º
	const handleActionClick = (action, track, e) => {
		e.stopPropagation()

		switch (action) {
			case 'select':
				onTrackSelect(track)
				break
			case 'view':
				window.open(track.url, '_blank')
				break
			case 'download':
				// –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
				const link = document.createElement('a')
				link.href = track.url
				link.download = track.filename
				document.body.appendChild(link)
				link.click()
				document.body.removeChild(link)
				break
			case 'edit':
				onTrackSelect(track)
				break
			case 'play':
				onTrackSelect(track)
				break
			case 'compare':
				onTrackSelect(track)
				break
			case 'split':
				onTrackSelect(track)
				break
		}
	}

	if (tracks.length === 0) {
		return (
			<Empty
				image={Empty.PRESENTED_IMAGE_SIMPLE}
				description={
					<div className={styles.emptyContainer}>
						<Text type='secondary'>–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö GPX —Ç—Ä–µ–∫–æ–≤</Text>
						<Text type='secondary' className={styles.emptySubtext}>
							–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–µ–∫ —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–î–æ–±–∞–≤–∏—Ç—å" –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–µ–∑–¥–æ–≤
						</Text>
					</div>
				}
			/>
		)
	}

	return (
		<div className={styles.container}>
			<Alert
				message='–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
				description='–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è –∏–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è'
				type='info'
				showIcon
				className={styles.infoAlert}
			/>

			<List
				dataSource={tracks}
				renderItem={track => (
					<List.Item key={track.id}>
						<Card
							className={`${styles.trackCard} ${
								selectedTrack?.id === track.id ? styles.selected : ''
							}`}
							onClick={() => onTrackSelect(track)}
						>
							<div className={styles.cardContent}>
								{/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
								<div className={styles.mainInfo}>
									<div className={styles.trackHeader}>
										<Text strong className={styles.filename}>
											{track.filename}
										</Text>
										{track.verified && (
											<Tooltip title='–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π —Ç—Ä–µ–∫'>
												<Tag
													icon={<CheckCircleOutlined />}
													color='success'
													className={styles.verifiedTag}
												>
													–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
												</Tag>
											</Tooltip>
										)}
									</div>

									<div className={styles.metadata}>
										<Space size='large' wrap>
											<div className={styles.metaItem}>
												<Text type='secondary'>–î–∞—Ç–∞:</Text>
												<Text strong className={styles.metaValue}>
													{formatDate(track.date)}
												</Text>
											</div>

											<div className={styles.metaItem}>
												<Text type='secondary'>–í—Ä–µ–º—è:</Text>
												<Tag color='green' className={styles.timeTag}>
													{formatTime(track.time)}
												</Tag>
											</div>

											{track.skiModel && (
												<div className={styles.metaItem}>
													<Text type='secondary'>–õ—ã–∂–∏:</Text>
													<Text strong className={styles.metaValue}>
														{track.skiModel}
													</Text>
												</div>
											)}

											{track.comment && (
												<div className={styles.metaItem}>
													<Text type='secondary'>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</Text>
													<Text className={styles.comment}>
														{track.comment}
													</Text>
												</div>
											)}
										</Space>
									</div>
								</div>

								{/* –î–µ–π—Å—Ç–≤–∏—è */}
								<div className={styles.actions}>
									<Space wrap>
										<Tooltip title='–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ'>
											<Button
												icon={<EyeOutlined />}
												size='small'
												onClick={e => handleActionClick('view', track, e)}
											/>
										</Tooltip>

										<Tooltip title='–°–∫–∞—á–∞—Ç—å GPX —Ñ–∞–π–ª'>
											<Button
												icon={<DownloadOutlined />}
												size='small'
												onClick={e => handleActionClick('download', track, e)}
											/>
										</Tooltip>

										<Tooltip title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–∫'>
											<Button
												icon={<ScissorOutlined />}
												size='small'
												type={
													selectedTrack?.id === track.id ? 'primary' : 'default'
												}
												onClick={e => handleActionClick('edit', track, e)}
											/>
										</Tooltip>

										<Tooltip title='–ü—Ä–æ–∏–≥—Ä–∞—Ç—å —Ç—Ä–µ–∫'>
											<Button
												icon={<PlayCircleOutlined />}
												size='small'
												onClick={e => handleActionClick('play', track, e)}
											/>
										</Tooltip>

										<Tooltip title='–°—Ä–∞–≤–Ω–∏—Ç—å —Å –¥—Ä—É–≥–∏–º'>
											<Button
												icon={<SwapOutlined />}
												size='small'
												onClick={e => handleActionClick('compare', track, e)}
											/>
										</Tooltip>

										<Tooltip title='–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫—Ä—É–≥–∏'>
											<Button
												icon={<SplitCellsOutlined />}
												size='small'
												onClick={e => handleActionClick('split', track, e)}
											/>
										</Tooltip>

										<Popconfirm
											title='–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–∫?'
											description='–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç —Ç—Ä–µ–∫ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ñ–∞–π–ª–æ–≤.'
											onConfirm={() => handleDeleteTrack(track.id)}
											okText='–î–∞, —É–¥–∞–ª–∏—Ç—å'
											cancelText='–û—Ç–º–µ–Ω–∞'
											okType='danger'
										>
											<Button
												icon={<DeleteOutlined />}
												size='small'
												danger
												loading={loadingDelete === track.id}
											/>
										</Popconfirm>
									</Space>
								</div>
							</div>
						</Card>
					</List.Item>
				)}
				className={styles.list}
			/>
		</div>
	)
}



===== src/features/gpx-tools/ui/GpxPlayer.jsx =====
import React from 'react'
import { Card, Alert, Typography } from 'antd'
import { PlayCircleOutlined } from '@ant-design/icons'
import styles from './GpxPlayer.module.css'

const { Title, Text } = Typography

export default function GpxPlayer({ track, user }) {
	if (!track) {
		return null
	}

	return (
		<Card className={styles.container}>
			<div className={styles.header}>
				<Title level={4} className={styles.title}>
					<PlayCircleOutlined /> –ü—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å —Ç—Ä–µ–∫–∞
				</Title>
				<Text type='secondary' className={styles.subtitle}>
					{track.filename}
				</Text>
			</div>

			<Alert
				message='–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'
				description='–ü—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å —Å –ø–∞—É–∑–æ–π, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω.'
				type='info'
				showIcon
				className={styles.alert}
			/>

			<div className={styles.stats}>
				<div className={styles.statItem}>
					<Text type='secondary'>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</Text>
					<Text strong>
						{Math.floor(track.time / 60)}:
						{(track.time % 60).toString().padStart(2, '0')}
					</Text>
				</div>
				<div className={styles.statItem}>
					<Text type='secondary'>–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞:</Text>
					<Text strong>{new Date(track.date).toLocaleDateString('ru-RU')}</Text>
				</div>
				<div className={styles.statItem}>
					<Text type='secondary'>–ú–æ–¥–µ–ª—å –ª—ã–∂:</Text>
					<Text strong>{track.skiModel || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</Text>
				</div>
			</div>
		</Card>
	)
}



===== src/features/gpx-tools/ui/GpxSplitter.jsx =====
import React from 'react'
import { Card, Alert, Typography, Button } from 'antd'
import { SplitCellsOutlined, RocketOutlined } from '@ant-design/icons'
import styles from './GpxSplitter.module.css'

const { Title, Text } = Typography

export default function GpxSplitter({ track, onTrackUpdated, user }) {
	if (!track) {
		return null
	}

	return (
		<Card className={styles.container}>
			<div className={styles.header}>
				<Title level={4} className={styles.title}>
					<SplitCellsOutlined /> –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∫—Ä—É–≥–∏
				</Title>
				<Text type='secondary' className={styles.subtitle}>
					–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä—É–≥–æ–≤ –ø–æ —ç—Ç–∞–ª–æ–Ω–Ω–æ–º—É —Ç—Ä–µ–∫—É
				</Text>
			</div>

			<Alert
				message='–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'
				description='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –Ω–∞ –∫—Ä—É–≥–∏ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ.'
				type='info'
				showIcon
				className={styles.alert}
			/>

			<div className={styles.workflow}>
				<div className={styles.step}>
					<div className={styles.stepNumber}>1</div>
					<div className={styles.stepContent}>
						<Text strong>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —ç—Ç–∞–ª–æ–Ω–Ω—ã–π —Ç—Ä–µ–∫</Text>
						<Text type='secondary'>GPX —Ñ–∞–π–ª —Å –æ–¥–Ω–∏–º –∏–¥–µ–∞–ª—å–Ω—ã–º –∫—Ä—É–≥–æ–º</Text>
					</div>
				</div>

				<div className={styles.arrow}>‚Üí</div>

				<div className={styles.step}>
					<div className={styles.stepNumber}>2</div>
					<div className={styles.stepContent}>
						<Text strong>–ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–∫–∞</Text>
						<Text type='secondary'>
							–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ –∫—Ä—É–≥–æ–≤
						</Text>
					</div>
				</div>

				<div className={styles.arrow}>‚Üí</div>

				<div className={styles.step}>
					<div className={styles.stepNumber}>3</div>
					<div className={styles.stepContent}>
						<Text strong>–í—ã–±–æ—Ä –∑–∞—á–µ—Ç–Ω–æ–≥–æ –∫—Ä—É–≥–∞</Text>
						<Text type='secondary'>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∫—Ä—É–≥–æ–≤ –∏ –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ</Text>
					</div>
				</div>
			</div>

			<div className={styles.actions}>
				<Button type='primary' icon={<RocketOutlined />} size='large' disabled>
					–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
				</Button>
				<Text type='secondary' className={styles.hint}>
					–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞: {track.filename}
				</Text>
			</div>
		</Card>
	)
}



===== src/features/gpx-tools/ui/GpxToolsPage.jsx =====
import React, { useState, useEffect } from 'react'
import { Card, Tabs, Spin, Alert, Typography, Space } from 'antd'
import {
	FileOutlined,
	ScissorOutlined,
	PlayCircleOutlined,
	SwapOutlined,
	SplitCellsOutlined,
} from '@ant-design/icons'
import { supabase } from '../../../shared/api/supabase'
import GpxList from './GpxList'
import GpxEditor from './GpxEditor'
import GpxPlayer from './GpxPlayer'
import GpxComparator from './GpxComparator'
import GpxSplitter from './GpxSplitter'
import styles from './GpxToolsPage.module.css'

const { TabPane } = Tabs
const { Title, Text } = Typography

export default function GpxToolsPage({ user }) {
	const [loading, setLoading] = useState(true)
	const [tracks, setTracks] = useState([])
	const [selectedTrack, setSelectedTrack] = useState(null)
	const [activeTab, setActiveTab] = useState('list')

	useEffect(() => {
		loadUserTracks()
	}, [user])

	async function loadUserTracks() {
		if (!user) {
			setLoading(false)
			return
		}

		try {
			setLoading(true)

			const { data: lapTimes, error } = await supabase
				.from('lap_times')
				.select('id, time_seconds, gpx_track_url, date, ski_model, comment')
				.eq('user_id', user.id)
				.not('gpx_track_url', 'is', null)
				.order('date', { ascending: false })

			if (error) throw error

			const formattedTracks = lapTimes.map(lap => ({
				id: lap.id,
				url: lap.gpx_track_url,
				time: lap.time_seconds,
				date: lap.date,
				skiModel: lap.ski_model,
				comment: lap.comment,
				filename: lap.gpx_track_url?.split('/').pop() || 'track.gpx',
			}))

			setTracks(formattedTracks)
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–∫–æ–≤:', error)
		} finally {
			setLoading(false)
		}
	}

	const handleTrackSelect = track => {
		setSelectedTrack(track)
	}

	const handleTabChange = key => {
		setActiveTab(key)
	}

	if (loading) {
		return (
			<div className={styles.loadingContainer}>
				<Spin size='large' />
				<div className={styles.loadingText}>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–æ–≤...</div>
			</div>
		)
	}

	if (!user) {
		return (
			<Alert
				message='–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'
				description='–î–ª—è —Ä–∞–±–æ—Ç—ã —Å GPX —Ç—Ä–µ–∫–∞–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.'
				type='warning'
				showIcon
				className={styles.authAlert}
			/>
		)
	}

	return (
		<Card className={styles.container}>
			<Space direction='vertical' size='large' className={styles.content}>
				<div className={styles.header}>
					<Title level={3} className={styles.title}>
						üéØ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è GPX —Ç—Ä–µ–∫–æ–≤
					</Title>
					<Text type='secondary' className={styles.subtitle}>
						–†–∞–±–æ—Ç–∞–π—Ç–µ —Å –≤–∞—à–∏–º–∏ –ª—ã–∂–Ω—ã–º–∏ —Ç—Ä–µ–∫–∞–º–∏: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ,
						—Å—Ä–∞–≤–Ω–∏–≤–∞–π—Ç–µ
					</Text>
				</div>

				<Tabs
					activeKey={activeTab}
					onChange={handleTabChange}
					type='card'
					size='large'
					className={styles.tabs}
				>
					<TabPane
						tab={
							<span className={styles.tabLabel}>
								<FileOutlined /> –ú–æ–∏ —Ç—Ä–µ–∫–∏
							</span>
						}
						key='list'
					>
						<GpxList
							tracks={tracks}
							selectedTrack={selectedTrack}
							onTrackSelect={handleTrackSelect}
							onTrackDeleted={loadUserTracks}
							user={user}
						/>
					</TabPane>

					<TabPane
						tab={
							<span className={styles.tabLabel}>
								<ScissorOutlined /> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
							</span>
						}
						key='edit'
						disabled={!selectedTrack}
					>
						<GpxEditor
							track={selectedTrack}
							onTrackUpdated={loadUserTracks}
							user={user}
						/>
					</TabPane>

					<TabPane
						tab={
							<span className={styles.tabLabel}>
								<PlayCircleOutlined /> –ü—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å
							</span>
						}
						key='play'
						disabled={!selectedTrack}
					>
						<GpxPlayer track={selectedTrack} user={user} />
					</TabPane>

					<TabPane
						tab={
							<span className={styles.tabLabel}>
								<SwapOutlined /> –°—Ä–∞–≤–Ω–∏—Ç—å
							</span>
						}
						key='compare'
						disabled={!selectedTrack}
					>
						<GpxComparator track={selectedTrack} tracks={tracks} user={user} />
					</TabPane>

					<TabPane
						tab={
							<span className={styles.tabLabel}>
								<SplitCellsOutlined /> –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –∫—Ä—É–≥–∏
							</span>
						}
						key='split'
						disabled={!selectedTrack}
					>
						<GpxSplitter
							track={selectedTrack}
							onTrackUpdated={loadUserTracks}
							user={user}
						/>
					</TabPane>
				</Tabs>

				{!selectedTrack && activeTab !== 'list' && (
					<Alert
						message='–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫'
						description="–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ '–ú–æ–∏ —Ç—Ä–µ–∫–∏'"
						type='info'
						showIcon
						className={styles.selectAlert}
					/>
				)}
			</Space>
		</Card>
	)
}



===== src/features/gpx-tools/ui/components/TrackVisualizer.jsx =====
import React, { useEffect, useRef, useState } from 'react'
import L from 'leaflet'
import 'leaflet/dist/leaflet.css'
import 'leaflet-gpx'
import styles from './TrackVisualizer.module.css'

const TrackVisualizer = ({ gpxUrl, onTrackLoaded, startMarker, endMarker }) => {
	const mapContainerRef = useRef(null)
	const mapInstanceRef = useRef(null)
	const gpxLayerRef = useRef(null)
	const [loading, setLoading] = useState(true)
	const [trackStats, setTrackStats] = useState(null)
	const [mapReady, setMapReady] = useState(false)

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã - –û–î–ò–ù –†–ê–ó
	useEffect(() => {
		if (!mapContainerRef.current || mapInstanceRef.current) return

		console.log('üó∫Ô∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é –∫–∞—Ä—Ç—É...')

		const mapInstance = L.map(mapContainerRef.current).setView(
			[52.416925, 103.738906],
			15
		)

		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
			attribution: '¬© OpenStreetMap',
			maxZoom: 19,
		}).addTo(mapInstance)

		mapInstanceRef.current = mapInstance

		// –î–∞–µ–º –∫–∞—Ä—Ç–µ –≤—Ä–µ–º—è –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è
		setTimeout(() => {
			setMapReady(true)
			console.log('‚úÖ –ö–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞')
		}, 300)

		return () => {
			console.log('üóëÔ∏è –£–¥–∞–ª—è—é –∫–∞—Ä—Ç—É')
			if (mapInstanceRef.current) {
				mapInstanceRef.current.remove()
				mapInstanceRef.current = null
				setMapReady(false)
			}
		}
	}, []) // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –û–î–ò–ù –†–ê–ó

	// –ó–∞–≥—Ä—É–∑–∫–∞ GPX –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–∞ –≥–æ—Ç–æ–≤–∞
	useEffect(() => {
		if (!mapReady || !mapInstanceRef.current || !gpxUrl) {
			console.log('‚è≥ –û–∂–∏–¥–∞—é:', { mapReady, gpxUrl: !!gpxUrl })
			return
		}

		console.log('üöÄ –ó–∞–≥—Ä—É–∂–∞—é GPX')

		const loadGpx = () => {
			try {
				setLoading(true)

				// –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ —Å–ª–æ—è
				if (gpxLayerRef.current) {
					mapInstanceRef.current.removeLayer(gpxLayerRef.current)
				}

				// –°–æ–∑–¥–∞–Ω–∏–µ GPX —Å–ª–æ—è
				gpxLayerRef.current = new L.GPX(gpxUrl, {
					async: true,
					polyline_options: {
						color: '#1890ff',
						weight: 4,
						opacity: 0.8,
						lineCap: 'round',
					},
					marker_options: null,
				})

				// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏
				gpxLayerRef.current.on('loaded', e => {
					console.log('‚úÖ GPX –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ')
					const track = e.target

					// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ —Ç—Ä–µ–∫–∞
					let points = []
					try {
						// –°–ø–æ—Å–æ–± 1: —á–µ—Ä–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É leaflet
						if (track._layers) {
							Object.values(track._layers).forEach(layer => {
								if (
									layer.getLatLngs &&
									typeof layer.getLatLngs === 'function'
								) {
									const latLngs = layer.getLatLngs()
									if (Array.isArray(latLngs) && latLngs.length > 0) {
										// –ï—Å–ª–∏ —ç—Ç–æ –ø–ª–æ—Å–∫–∏–π –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫
										if (latLngs[0].lat !== undefined) {
											points = latLngs.map((ll, index) => ({
												lat: ll.lat,
												lng: ll.lng,
												index: index,
											}))
										}
										  console.log('üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ track:', {
    keys: Object.keys(track),
    layers: track._layers ? Object.keys(track._layers) : '–Ω–µ—Ç —Å–ª–æ–µ–≤',
    hasGetLatLngs: !!track.getLatLngs,
    has_distance: !!track.get_distance,
    has_name: !!track.get_name,
    bounds: track.getBounds ? track.getBounds() : '–Ω–µ—Ç bounds',
    gpxData: track._gpx ? '–µ—Å—Ç—å XML –¥–∞–Ω–Ω—ã–µ' : '–Ω–µ—Ç XML',
  });
    if (track._layers) {
			const firstLayerKey = Object.keys(track._layers)[0]
			const firstLayer = track._layers[firstLayerKey]
			console.log('üîç –ü–µ—Ä–≤—ã–π —Å–ª–æ–π:', {
				type: firstLayer?.constructor?.name,
				hasGetLatLngs: !!firstLayer?.getLatLngs,
				latLngs: firstLayer?.getLatLngs ? firstLayer.getLatLngs() : '–Ω–µ—Ç —Ç–æ—á–µ–∫',
			})
		}
		// –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤ (–º—É–ª—å—Ç–∏–ø–æ–ª–∏–ª–∏–Ω–∏—è)
		else if (Array.isArray(latLngs[0])) {
			latLngs.forEach(segment => {
				if (Array.isArray(segment)) {
					segment.forEach((ll, index) => {
						if (ll && ll.lat) {
							points.push({
								lat: ll.lat,
								lng: ll.lng,
								index: points.length,
							})
						}
					})
				}
			})
		}
									}
								}
							})
						}

						// –°–ø–æ—Å–æ–± 2: –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ç–æ—á–µ–∫, —Å–æ–∑–¥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ
						if (points.length === 0 && track.getBounds) {
							const bounds = track.getBounds()
							const center = bounds.getCenter()
							points = [
								{
									lat: center.lat,
									lng: center.lng,
									index: 0,
								},
							]
						}
					} catch (error) {
						console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–∫–∏ —Ç—Ä–µ–∫–∞:', error)
						points = []
					}

					const stats = {
						distance: track.get_distance ? track.get_distance() : 0,
						name: '–¢—Ä–µ–∫',
						pointsCount: points.length,
					}

					setTrackStats(stats)
					setLoading(false)

					// –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
					if (track.getBounds) {
						mapInstanceRef.current.fitBounds(track.getBounds().pad(0.1))
					}

					// –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –†–ê–ó–û–í–û —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
					if (onTrackLoaded) {
						console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –¥–∞–Ω–Ω—ã–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä, —Ç–æ—á–µ–∫:', points.length)
						onTrackLoaded(track, stats, points)
					}
				})

				gpxLayerRef.current.on('error', err => {
					console.error('‚ùå –û—à–∏–±–∫–∞ GPX:', err)
					setLoading(false)
				})

				gpxLayerRef.current.addTo(mapInstanceRef.current)
			} catch (error) {
				console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error)
				setLoading(false)
			}
		}

		loadGpx()

		return () => {
			if (gpxLayerRef.current && mapInstanceRef.current) {
				mapInstanceRef.current.removeLayer(gpxLayerRef.current)
				gpxLayerRef.current = null
			}
		}
	}, [gpxUrl, mapReady]) // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: gpxUrl –∏ mapReady

	useEffect(() => {
		if (
			!mapReady ||
			!mapInstanceRef.current ||
			startMarker === undefined ||
			endMarker === undefined
		) {
			return
		}

		console.log('üìç –û–±–Ω–æ–≤–ª—è—é –º–∞—Ä–∫–µ—Ä—ã –æ–±—Ä–µ–∑–∫–∏:', { startMarker, endMarker })

		// –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
		if (window.startTrimMarker) {
			mapInstanceRef.current.removeLayer(window.startTrimMarker)
			window.startTrimMarker = null
		}
		if (window.endTrimMarker) {
			mapInstanceRef.current.removeLayer(window.endTrimMarker)
			window.endTrimMarker = null
		}

		// –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ –º–∞—Ä–∫–µ—Ä—ã –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
		// –ü–æ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã, –ø–æ—Ç–æ–º –∑–∞–º–µ–Ω–∏–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏
		const mapCenter = mapInstanceRef.current.getCenter()

		// –ú–∞—Ä–∫–µ—Ä –Ω–∞—á–∞–ª–∞ –æ–±—Ä–µ–∑–∫–∏
		window.startTrimMarker = L.marker(
			[mapCenter.lat - 0.0005, mapCenter.lng - 0.0005], // –ù–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
			{
				icon: L.divIcon({
					className: styles.trimMarker,
					html: '<div style="background: #52c41a; color: white; padding: 6px 12px; border-radius: 16px; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üî™ –ù–ê–ß–ê–õ–û</div>',
					iconSize: [80, 24],
					iconAnchor: [40, 12],
				}),
			}
		)
			.addTo(mapInstanceRef.current)
			.bindPopup(`–ù–∞—á–∞–ª–æ –æ–±—Ä–µ–∑–∫–∏<br>–¢–æ—á–∫–∞ ${startMarker}`)

		// –ú–∞—Ä–∫–µ—Ä –∫–æ–Ω—Ü–∞ –æ–±—Ä–µ–∑–∫–∏
		window.endTrimMarker = L.marker(
			[mapCenter.lat + 0.0005, mapCenter.lng + 0.0005], // –ù–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
			{
				icon: L.divIcon({
					className: styles.trimMarker,
					html: '<div style="background: #f5222d; color: white; padding: 6px 12px; border-radius: 16px; font-weight: bold; font-size: 12px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">üî™ –ö–û–ù–ï–¶</div>',
					iconSize: [70, 24],
					iconAnchor: [35, 12],
				}),
			}
		)
			.addTo(mapInstanceRef.current)
			.bindPopup(`–ö–æ–Ω–µ—Ü –æ–±—Ä–µ–∑–∫–∏<br>–¢–æ—á–∫–∞ ${endMarker}`)

		// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
		return () => {
			if (window.startTrimMarker && mapInstanceRef.current) {
				mapInstanceRef.current.removeLayer(window.startTrimMarker)
				window.startTrimMarker = null
			}
			if (window.endTrimMarker && mapInstanceRef.current) {
				mapInstanceRef.current.removeLayer(window.endTrimMarker)
				window.endTrimMarker = null
			}
		}
	}, [startMarker, endMarker, mapReady])

	return (
		<div className={styles.container}>
			<div
				ref={mapContainerRef}
				className={styles.mapContainer}
				style={{
					width: '100%',
					height: '400px',
					minHeight: '400px',
					borderRadius: '8px',
					overflow: 'hidden',
					border: '1px solid #f0f0f0',
					position: 'relative',
				}}
			/>

			{loading && (
				<div className={styles.loadingOverlay}>
					<div className={styles.spinner} />
					<div>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞...</div>
				</div>
			)}

			{!mapReady && !loading && (
				<div className={styles.loadingOverlay}>
					<div>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...</div>
				</div>
			)}

			{trackStats && (
				<div className={styles.statsPanel}>
					<h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–µ–∫–∞:</h4>
					<div className={styles.statsGrid}>
						<div className={styles.statItem}>
							<span className={styles.statLabel}>–î–∏—Å—Ç–∞–Ω—Ü–∏—è:</span>
							<span className={styles.statValue}>
								{(trackStats.distance / 1000).toFixed(2)} –∫–º
							</span>
						</div>
					</div>
				</div>
			)}
		</div>
	)
}

export default TrackVisualizer



